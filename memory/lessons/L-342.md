# L-342 — PreCompact hook: fires before compaction, checkpoint mechanism now wired

Date: 2026-02-28 | Session: S301 | Domain: claude-code | Confidence: Measured (docs + S301 wiring)

## Finding (F-CC3)
PreCompact is a real, officially supported Claude Code hook type. Fires before BOTH
manual (/compact) and auto-compaction. Receives: session_id, transcript_path (path to
.jsonl conversation file), cwd, trigger ("manual"|"auto"), custom_instructions.

## Limitations
- Cannot block or cancel compaction — side effects only.
- Only supports `type: "command"` hooks (not prompt or agent hooks).
- No decision control: cannot inject text into the compacted context.

## What this enables
With transcript_path in hand, the hook can: snapshot NEXT.md, list uncommitted files,
read recent git log, and write a workspace/precompact-checkpoint-<id>.json. Post-compaction
session reads the checkpoint file via orient.py to resume without full re-orientation.

## Implementation (S301)
- tools/hooks/pre-compact-checkpoint.py: writes checkpoint JSON on every compaction.
- .claude/settings.json: PreCompact hook wired.
- Checkpoint schema v1: session_id, trigger, next_md sections, uncommitted_files,
  recent_workspace_files, recent_git_log, resume_hint.

## Gap remaining (F-CC3 partial)
Checkpoint is written but not auto-consumed: orient.py does not yet read it.
Next step: if workspace/precompact-checkpoint-*.json exists, orient.py should surface
the most recent one in its output.

## Linked
F-CC3, L-325, tools/hooks/pre-compact-checkpoint.py, .claude/settings.json
