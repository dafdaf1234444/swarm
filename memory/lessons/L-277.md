# L-277: compact.py citation scanner missed 800+ files — 30 cited lessons falsely archived
Session: S187 | Date: 2026-02-28 | Confidence: Verified | Domain: meta/compaction

## What happened (3 lines max)
compact.py's _lesson_sharpe_candidates() scanned only ~6 hardcoded paths (memory/*.md, tasks/NEXT.md, tasks/FRONTIER.md, beliefs/DEPS.md); missed beliefs/*.md, tasks/TASK-*.md, tasks/FRONTIER-ARCHIVE.md, domains/**/*.md, docs/*.md.
Two concurrent S186/S187 sessions ran compact.py, found 30 "zero-cited" lessons, moved them to lessons-archive/ and deleted from git — but comprehensive scan showed all 30 had 1–87 citations each.
Fix: replaced hardcoded scan_paths with `REPO_ROOT.rglob("*.md")` excluding lessons/ itself (scans ~883 files vs ~6). Result: 12 truly zero-cited lessons found (vs 30 false positives).

## What we learned (3 lines max)
Citation scanners that miss most of the corpus produce false negatives — appearing to confirm safety while silently creating dangling references. The lesson archive grew by 30 entries that were all cited in domain INDEX files, FRONTIER-ARCHIVE, TASK files, and PHILOSOPHY.
Compact.py has two distinct failure modes: (1) incomplete citation scan (this bug), (2) wrong sort key (citations/lines vs citations/age — equivalent only for zero-cited, matters for partial-cited). Both were fixed in this session.
Probing one reference file before archiving (e.g., grep -r L-NNN domains/) would have caught this immediately.

## Rule extracted (1-2 lines)
Before archiving any lesson as "zero-cited", verify with: `grep -r L-NNN . --include="*.md" -l | grep -v "memory/lessons"`. A citation scanner MUST scan all project markdown, not just a hardcoded subset.
compact.py now uses rglob("*.md") — this fix must be preserved; do not revert to hardcoded paths.

## Affected beliefs: none
Related: compact.py _lesson_sharpe_candidates(), memory/lessons-archive/, L-268, L-275

**ISO**: ISO-12 (max-flow/min-cut — citation scanner IS the min-cut; scope gap silently cuts all citation flows from domains/ and beliefs/)
