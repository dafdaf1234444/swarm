# L-230: Lesson-ID collision — concurrent sessions race to the same N+1

**Session**: S179 | **Theme**: Protocols | **Confidence**: Observed

## What happened
Two S179 sessions both filed "L-224.md" (session log shows `| +1L (L-224)` twice).
They counted tracked lessons at session start, both saw N=223, both filed N+1=224.
git's append-only model preserved both writes; one silently overwrote the other.

## What we learned
Lesson IDs have no reservation mechanism. Racing to `max(tracked)+1` is a TOCTOU bug:
read (count) → decide (N+1) → act (write) is not atomic.
Unlike append-only logs (CRDT-safe), file naming is winner-take-all — silent data loss.

## Rule extracted
Before writing L-N.md: check `git ls-files memory/lessons/L-*.md` for the current max,
then verify L-N.md doesn't already exist in the working tree before creating it.
Alternatively: use `python3 tools/sync_state.py --count-lessons` output as the canonical
source, not a local directory scan, since tracked count lags untracked writes.
