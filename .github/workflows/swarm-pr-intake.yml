name: swarm-pr-intake

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - ready_for_review

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: swarm-pr-intake-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  intake-plan:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build swarm intake plan
        run: |
          set -euo pipefail
          python tools/swarm_pr.py plan "${{ github.event.pull_request.base.sha }}" "${{ github.event.pull_request.head.sha }}" --json > swarm-pr-plan.json
          python - <<'PY'
          import json
          from pathlib import Path

          plan = json.loads(Path("swarm-pr-plan.json").read_text(encoding="utf-8"))
          lanes = plan.get("lanes", [])
          lines = [
              "<!-- swarm-pr-plan -->",
              "## Swarm Intake Plan",
              f"- Range: `{plan['range']}`",
              f"- Mode: `{plan['mode']}`",
              f"- Fingerprint: `{plan['fingerprint']}`",
              f"- Changed files: `{plan['summary']['changed_files']}`",
              f"- Lane count: `{plan['summary']['lane_count']}`",
              "",
              "### Lanes",
          ]
          if lanes:
              for lane in lanes:
                  lines.append(
                      f"- `{lane['name']}` ({lane['topology']}): {len(lane.get('changes', []))} file(s)"
                  )
          else:
              lines.append("- none")
          lines.extend(
              [
                  "",
                  "Generated by `tools/swarm_pr.py` via GitHub Actions.",
              ]
          )
          Path("swarm-pr-plan-comment.md").write_text("\n".join(lines) + "\n", encoding="utf-8")
          PY

      - name: Upload intake artifacts
        uses: actions/upload-artifact@v4
        with:
          name: swarm-pr-intake-plan
          path: |
            swarm-pr-plan.json
            swarm-pr-plan-comment.md

      - name: Publish plan comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const body = fs.readFileSync("swarm-pr-plan-comment.md", "utf8");
            const marker = "<!-- swarm-pr-plan -->";
            const issue_number = context.payload.pull_request.number;
            const { owner, repo } = context.repo;

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number,
              per_page: 100,
            });

            const existing = comments.find(
              (c) => c.user?.type === "Bot" && typeof c.body === "string" && c.body.includes(marker),
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body,
              });
            }
